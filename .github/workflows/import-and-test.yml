name: Import & Tests

on:
  push:
    branches: [ main ]
  pull_request:
  schedule:
    - cron: '0 4 1 * *'   # monthly run (adjust as needed)

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install deps
        run: pip install -r requirements.txt
      - name: Run tests
        run: pytest -q

  import-ref:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install deps
        run: pip install -r requirements.txt
      - name: Run import (download)
        env:
          NROD_USERNAME: ${{ secrets.NROD_USERNAME }}
          NROD_PASSWORD: ${{ secrets.NROD_PASSWORD }}
        run: |
          python import_scripts/nrod_ref_import.py --db nrod_ref.sqlite --username "$NROD_USERNAME" --password "$NROD_PASSWORD" --outdir nrod_ref_downloads
